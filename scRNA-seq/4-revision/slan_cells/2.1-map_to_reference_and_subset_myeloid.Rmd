---
title: 'Map and subset myeloid cells (experiments 2 & 3 tonsil)'
author: "Ramon Massoni-Badosa"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document:
    toc: true
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "100%", fig.align='center', 
                      message=FALSE, warning = FALSE)
options(width = 1200)
```


# Introduction

The aim of this notebook is to integrate the cells profiled with scRNA-seq of the whole tonsil atlas and the slan+ cells we enriched. Then, we will transfer the label "annotation_level_1" and keep only those cells that are label as "myeloid" with high accuracy.

# Pre-processing

## Load packages

```{r}
library(Seurat)
library(tidyverse)
library(caret)
library(class)
library(harmony)
library(here)
library(glue)
library(DT)
```


## Define parameters

```{r}
path_to_slan <- here("scRNA-seq/results/R_objects/slancytes_revision/1.3.seurat_slan_cells_tonsil_filtered_experiments_2_and_3.rds")
path_to_tonsil <- here("scRNA-seq/results/R_objects/final_clusters/20220215/20220215_tonsil_atlas_rna_seurat_obj.rds")


# Misc
label_var <- "annotation_level_1"
batch_var <- "gem_id"

# Source key functions and variables
source(here("scRNA-seq/bin/utils_final_clusters.R"))
source(here("scRNA-seq/bin/SLOcatoR_functions.R"))
```


## Read data

```{r}
query <- readRDS(path_to_slan)
reference <- readRDS(path_to_tonsil)
reference <- reference[, reference$assay == "3P"]
```


# Merge

```{r}
# Define new variables for label transfer
reference$type <- "reference"
query$type <- "query"
reference$batch <- reference@meta.data[[batch_var]]
reference$label <- reference@meta.data[[label_var]]
reference$annotation_probability <- NA
reference$UMAP1 <- Embeddings(reference, "umap")[, "UMAP_1"]
reference$UMAP2 <- Embeddings(reference, "umap")[, "UMAP_2"]
query$label <- NA
query$annotation_probability <- NA
query$batch <- "query"
query$UMAP1 <- NA
query$UMAP2 <- NA


# Find common columns and subset
common_cols <- intersect(
  colnames(reference@meta.data),
  colnames(query@meta.data)
)
reference@meta.data <- reference@meta.data[, common_cols]
query@meta.data <- query@meta.data[, common_cols]


# Merge
merged <- merge(x = reference, y = query)
rm(reference)
gc()
```


## Integrate

Integrate with Harmony:

```{r}
# Integrate
shared_features <- find_assay_specific_features(merged, assay_var = "type")
merged <- integrate_assays(
  merged,
  assay_specific = TRUE,
  assay_var = "batch",
  shared_hvg = shared_features,
  n_dim = 30
)
# Visualize integration
merged <- RunUMAP(merged, dims = 1:30, reduction = "harmony")
DimPlot(merged, group.by = "type", split.by = "type")
```



# Transfer labels

```{r}
# Define training and test sets
data_sets <- split_training_and_test_sets(
  merged,
  split_var = "type",
  referece_label = "reference",
  query_label = "query",
  reduction = "harmony",
  n_dims = 30
)


# Transfer label
annotation_query_df <- transfer_label(
  seurat_obj = merged,
  training_set = data_sets$training_set,
  test_set = data_sets$test_set,
  k = 10,
  response_var = "label"
)
```



# Include annotations and plot

```{r}
if (all(colnames(query) == annotation_query_df$query_cells)) {
  query$annotation_level_1 <- annotation_query_df$annotation
  query$annotation_probability <- annotation_query_df$annotation_prob
}
DimPlot(query, group.by = "annotation_level_1")
FeaturePlot(query, "annotation_probability") &
  scale_color_viridis_c(option = "magma")
selected_cells <- 
  query$annotation_level_1 == "myeloid" &
  query$annotation_probability >= 0.9
query <- query[, selected_cells]
```


# Save

```{r}
saveRDS(query, here("scRNA-seq/results/R_objects/slancytes_revision/1.3.seurat_slan_cells_tonsil_classified_level_1_experiments_2_and_3.rds"))
```


# Session Information

```{r}
sessionInfo()
```

